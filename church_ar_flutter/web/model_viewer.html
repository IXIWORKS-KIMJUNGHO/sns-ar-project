<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Flutter UI ì˜¤ë²„ë ˆì´ë¥¼ ìœ„í•œ ê°„ë‹¨í•œ ì„¤ì • */
        /* ë³µì¡í•œ ì°¨ë‹¨ ë¡œì§ ì œê±°í•¨ */
        
        model-viewer {
            width: 100%;
            height: 100%;
        }

        /* iframe ê¸°ë³¸ ì„¤ì • - Flutter ì˜¤ë²„ë ˆì´ ë°©ì‹ ì‚¬ìš© */
        
        /* ë‚´ì¥ AR ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
        model-viewer::part(default-ar-button) {
            display: none !important;
        }

        /* AR ëª¨ë“œì—ì„œ ê¸°ë³¸ ì„¤ì • ì‚¬ìš© */
        
        /* AR ë²„íŠ¼ê³¼ ë°°ì¹˜ ë²„íŠ¼ CSS ì œê±°: Flutter UIì—ì„œ ì²˜ë¦¬ */

        /* í„°ì¹˜ ì´ë™ ì‹œìŠ¤í…œ CSS */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            100% { transform: scale(1.2); opacity: 0.9; }
        }

        .drag-feedback {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        /* í„°ì¹˜ ë¦¬í”Œ íš¨ê³¼ */
        .touch-ripple {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 122, 255, 0.3) 0%, rgba(0, 122, 255, 0) 70%);
            transform: scale(0);
            animation: ripple-effect 0.6s ease-out;
        }

        @keyframes ripple-effect {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* ëª¨ë¸ í„°ì¹˜ í•˜ì´ë¼ì´íŠ¸ */
        .model-highlight {
            position: absolute;
            pointer-events: none;
            background: rgba(0, 122, 255, 0.2);
            border: 2px solid rgba(0, 122, 255, 0.6);
            border-radius: 50%;
            animation: highlight-pulse 0.4s ease-out;
        }

        @keyframes highlight-pulse {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        @keyframes liquidPulse {
            0% {
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    0 2px 8px rgba(0, 122, 255, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 0 0 0 rgba(0, 122, 255, 0.3);
            }
            50% {
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    0 2px 8px rgba(0, 122, 255, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 0 0 8px rgba(0, 122, 255, 0.2);
            }
            100% {
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.1),
                    0 2px 8px rgba(0, 122, 255, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8),
                    0 0 0 0 rgba(0, 122, 255, 0);
            }
        }

        /* ğŸ¯ Ground Plane ì‹œê°í™” */
        .ground-plane {
            position: absolute;
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .ground-plane.show {
            opacity: 1;
            transform: scale(1);
        }

        .ground-plane::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            animation: plane-pulse 2s ease-in-out infinite;
        }

        @keyframes plane-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(255, 255, 255, 0);
                transform: scale(1.05);
            }
        }
    </style>
</head>
<body>
    <model-viewer
        id="church-model"
        src="assets/models/church-model-01.glb"
        alt="ì˜¨ëˆ„ë¦¬êµíšŒ 3D ëª¨ë¸"
        camera-controls
        ar
        ar-modes="webxr scene-viewer quick-look">

        <!-- AR ë²„íŠ¼ ì œê±°: Flutter UIì—ì„œ ì²˜ë¦¬ -->
    </model-viewer>

    <!-- ë°°ì¹˜ ë²„íŠ¼ ì œê±°: Flutter UIì—ì„œ ì²˜ë¦¬ -->

    <!-- Flutter UI ì˜¤ë²„ë ˆì´ ë°©ì‹ ì‚¬ìš© - ì°¨ë‹¨ div ë¶ˆí•„ìš” -->
    
    <script>
        // ğŸ” ë””ë²„ê¹…: í˜ì´ì§€ ë¡œë“œ í™•ì¸
        console.log('ğŸš€ model_viewer.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ë¨');

        // Model Viewer ì´ˆê¸°í™”
        const viewer = document.querySelector('#church-model');
        console.log('ğŸ¯ Model Viewer ì—˜ë¦¬ë¨¼íŠ¸:', viewer);

        // placementButton ì œê±°: Flutter UIì—ì„œ ì²˜ë¦¬
        let currentScale = 1.0;
        let lastTouchDistance = 0;
        let isPlacementMode = false;
        let isModelPlaced = false;
        let isPlaneDetected = false;

        // ğŸ¯ Ground Plane ë³€ìˆ˜
        let groundPlaneElement = null;
        let groundPlaneTimeout = null;

        // ëª¨ë¸ í”„ë¦¬ë¡œë”© ìºì‹œ
        const modelCache = new Map();
        const preloadedModels = [
            'assets/models/church-model-01.glb',
            'assets/models/church-model-02.glb',
            'assets/models/church-model-03.glb',
            'assets/models/church-model-04.glb',
            'assets/models/church-model-05.glb'
        ];

        // Flutterë¡œ ë©”ì‹œì§€ ì „ì†¡ í—¬í¼ í•¨ìˆ˜
        function sendMessageToFlutter(type, data = {}) {
            const message = {
                type: type,
                ...data
            };

            console.log('ğŸ“¤ Flutterì— ë©”ì‹œì§€ ì „ì†¡:', type);

            try {
                return window.parent.postMessage(message, '*');
            } catch (error) {
                console.error('âŒ ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                return null;
            }
        }

        // ëª¨ë¸ í”„ë¦¬ë¡œë”© í•¨ìˆ˜
        async function preloadModels() {
            console.log('ğŸš€ ëª¨ë¸ í”„ë¦¬ë¡œë”© ì‹œì‘...');

            for (const modelUrl of preloadedModels) {
                try {
                    const response = await fetch(modelUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const objectUrl = URL.createObjectURL(blob);
                        modelCache.set(modelUrl, objectUrl);
                        console.log(`âœ… í”„ë¦¬ë¡œë“œ ì™„ë£Œ: ${modelUrl}`);
                    }
                } catch (error) {
                    console.warn(`âš ï¸ í”„ë¦¬ë¡œë“œ ì‹¤íŒ¨: ${modelUrl}`, error);
                }
            }

            console.log('ğŸ‰ ëª¨ë“  ëª¨ë¸ í”„ë¦¬ë¡œë”© ì™„ë£Œ!');
            sendMessageToFlutter('modelsPreloaded', { count: modelCache.size });
        }

        // ì¦‰ì‹œ í”„ë¦¬ë¡œë”© ì‹œì‘ (í˜ì´ì§€ ë¡œë“œì™€ ë™ì‹œì—)
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ DOM ë¡œë“œ ì™„ë£Œ, ì¦‰ì‹œ í”„ë¦¬ë¡œë”© ì‹œì‘');
            preloadModels();
        });

        // window loadëŠ” ë°±ì—…ìš©
        window.addEventListener('load', () => {
            if (modelCache.size === 0) {
                console.log('ğŸ”„ window loadì—ì„œ í”„ë¦¬ë¡œë”© ì¬ì‹œë„');
                preloadModels();
            }
        });

        // í„°ì¹˜ ë¦¬í”Œ íš¨ê³¼ ìƒì„±
        function createTouchRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.className = 'touch-ripple';
            ripple.style.left = (x - 25) + 'px';
            ripple.style.top = (y - 25) + 'px';
            ripple.style.width = '50px';
            ripple.style.height = '50px';

            document.body.appendChild(ripple);

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì œê±°
            setTimeout(() => {
                if (ripple.parentNode) {
                    ripple.parentNode.removeChild(ripple);
                }
            }, 600);
        }

        // ëª¨ë¸ í„°ì¹˜ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼
        function createModelHighlight(x, y) {
            const highlight = document.createElement('div');
            highlight.className = 'model-highlight';
            highlight.style.left = (x - 20) + 'px';
            highlight.style.top = (y - 20) + 'px';
            highlight.style.width = '40px';
            highlight.style.height = '40px';

            document.body.appendChild(highlight);

            // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì œê±°
            setTimeout(() => {
                if (highlight.parentNode) {
                    highlight.parentNode.removeChild(highlight);
                }
            }, 400);
        }

        // ğŸ¯ Ground Plane ì‹œê°í™” í•¨ìˆ˜
        function showGroundPlane() {
            console.log('ğŸ” showGroundPlane í•¨ìˆ˜ í˜¸ì¶œë¨');
            console.log('ğŸ” viewer.arSession:', viewer.arSession);

            // AR ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (ì¼ë‹¨ ì£¼ì„ì²˜ë¦¬í•´ì„œ í…ŒìŠ¤íŠ¸)
            // if (!viewer.arSession) {
            //     console.log('âš ï¸ AR ì„¸ì…˜ì´ ì—†ì–´ì„œ Ground Plane í‘œì‹œ ì•ˆí•¨');
            //     return;
            // }

            // ê¸°ì¡´ Ground Plane ì œê±°
            hideGroundPlane();

            console.log('ğŸ¯ Ground Plane í‘œì‹œ ì¤‘...');

            try {
                // ëª¨ë¸ì˜ ë°”ìš´ë”© ë°•ìŠ¤ ê³„ì‚°
                const boundingBox = viewer.getBoundingClientRect();
                const modelBounds = viewer.model?.boundingBox;

                // Ground Plane ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„± (CSS í´ë˜ìŠ¤ ì—†ì´ ì§ì ‘ ìŠ¤íƒ€ì¼ ì ìš©)
                groundPlaneElement = document.createElement('div');

                // ëª¨ë¸ í¬ê¸°ì— ê¸°ë°˜í•œ í‰ë©´ í¬ê¸° ê³„ì‚°
                let planeWidth = 150;  // ê¸°ë³¸ í¬ê¸°
                let planeHeight = 150;

                console.log('ğŸ” planeWidth:', planeWidth, 'planeHeight:', planeHeight);

                // í™”ë©´ ì¤‘ì•™ í•˜ë‹¨ì— ë°°ì¹˜ (ARì—ì„œ ëª¨ë¸ì´ ë³´í†µ ì¤‘ì•™ì— ìœ„ì¹˜)
                const centerX = window.innerWidth / 2;
                const bottomY = window.innerHeight * 0.75; // í™”ë©´ í•˜ë‹¨ 25% ì§€ì 

                console.log('ğŸ” centerX:', centerX, 'bottomY:', bottomY);

                // ì§ì ‘ ìŠ¤íƒ€ì¼ ì ìš© (CSS í´ë˜ìŠ¤ ì˜ì¡´ ì œê±°)
                groundPlaneElement.style.position = 'absolute';
                groundPlaneElement.style.border = '3px solid rgba(255, 255, 255, 0.9)';
                groundPlaneElement.style.borderRadius = '8px';
                groundPlaneElement.style.background = 'rgba(255, 255, 255, 0.1)';
                groundPlaneElement.style.pointerEvents = 'none';
                groundPlaneElement.style.zIndex = '1000';
                groundPlaneElement.style.width = planeWidth + 'px';
                groundPlaneElement.style.height = planeHeight + 'px';
                groundPlaneElement.style.left = (centerX - planeWidth/2) + 'px';
                groundPlaneElement.style.top = (bottomY - planeHeight/2) + 'px';

                // DOMì— ì¶”ê°€
                document.body.appendChild(groundPlaneElement);
                console.log('ğŸ” Ground Plane ì—˜ë¦¬ë¨¼íŠ¸ê°€ DOMì— ì¶”ê°€ë¨');

                // ì¦‰ì‹œ í‘œì‹œ (CSS ì• ë‹ˆë©”ì´ì…˜ ì œê±°)
                groundPlaneElement.style.opacity = '1';
                groundPlaneElement.style.display = 'block';

                // Flutterì— ì•Œë¦¼
                sendMessageToFlutter('groundPlaneShown', {
                    width: planeWidth,
                    height: planeHeight,
                    x: centerX,
                    y: bottomY
                });

                // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
                groundPlaneTimeout = setTimeout(() => {
                    hideGroundPlane();
                }, 3000);

            } catch (error) {
                console.log('âš ï¸ Ground Plane ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        function hideGroundPlane() {
            console.log('ğŸ” hideGroundPlane í•¨ìˆ˜ í˜¸ì¶œë¨');

            if (groundPlaneTimeout) {
                clearTimeout(groundPlaneTimeout);
                groundPlaneTimeout = null;
            }

            if (groundPlaneElement) {
                console.log('ğŸ” Ground Plane ì—˜ë¦¬ë¨¼íŠ¸ ì œê±° ì¤‘...');

                // ì§ì ‘ ì œê±° (CSS ì• ë‹ˆë©”ì´ì…˜ ì—†ì´)
                if (groundPlaneElement.parentNode) {
                    groundPlaneElement.parentNode.removeChild(groundPlaneElement);
                }
                groundPlaneElement = null;

                console.log('ğŸ¯ Ground Plane ìˆ¨ê¹€ ì™„ë£Œ');
            }
        }

        // Flutterì™€ í†µì‹ í•  ìˆ˜ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤
        window.addEventListener('message', (event) => {
            console.log('ğŸ”„ HTML ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);

            if (event.data.type === 'startAR') {
                console.log('ğŸš€ Flutterì—ì„œ AR ì‹œì‘ ìš”ì²­');
                viewer.activateAR();
                sendMessageToFlutter('arButtonPressed');
            } else if (event.data.type === 'resetView') {
                console.log('ğŸ”„ ë·° ë¦¬ì…‹ ìš”ì²­');
                viewer.cameraOrbit = viewer.cameraOrbit; // ê¸°ë³¸ê°’ ìœ ì§€
                currentScale = 1.0;
            } else if (event.data.type === 'changeModel') {
                console.log('ğŸ¯ ëª¨ë¸ ë³€ê²½ ìš”ì²­:', event.data.src, event.data.name);
                changeModel(event.data.src, event.data.name);
            } else if (event.data.type === 'placeModel') {
                console.log('ğŸ“ Flutterì—ì„œ ëª¨ë¸ ë°°ì¹˜ ìš”ì²­:', event.data.x, event.data.y);
                if (isPlacementMode && !isModelPlaced) {
                    placeModelAtPosition(event.data.x || window.innerWidth / 2, event.data.y || window.innerHeight / 2);
                }
            } else {
                console.log('â“ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', event.data.type);
            }
        });

        // ê°œì„ ëœ ëª¨ë¸ ë³€ê²½ í•¨ìˆ˜ (ì¦‰ì‹œ ë³€ê²½ + ìºì‹œ ìš°ì„ )
        function changeModel(newSrc, newName) {
            console.log('ğŸ”„ ëª¨ë¸ ë³€ê²½:', newName);

            // ë™ì¼í•œ ëª¨ë¸ì¸ ê²½ìš° ì¦‰ì‹œ ë¦¬í„´
            if (viewer.src === newSrc || viewer.src.endsWith(newSrc)) {
                console.log('âš ï¸ ë™ì¼í•œ ëª¨ë¸ì´ë¯€ë¡œ ë³€ê²½í•˜ì§€ ì•ŠìŒ:', newName);
                sendMessageToFlutter('modelLoaded', { src: newSrc, name: newName });
                return;
            }

            // ë¡œë”© ìƒíƒœ ì•Œë¦¼
            sendMessageToFlutter('modelLoading', { src: newSrc, name: newName });

            // ìºì‹œëœ ëª¨ë¸ í™•ì¸
            const cachedUrl = modelCache.get(newSrc);
            const finalSrc = cachedUrl || newSrc;

            if (cachedUrl) {
                console.log('âš¡ ìºì‹œëœ ëª¨ë¸ ì‚¬ìš©:', newName);
                // ìºì‹œëœ ê²½ìš° ì¦‰ì‹œ ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                setTimeout(() => {
                    sendMessageToFlutter('modelLoaded', { src: newSrc, name: newName });
                }, 100);
            } else {
                console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ì—ì„œ ëª¨ë¸ ë¡œë”©:', newName);
                // ë„¤íŠ¸ì›Œí¬ ë¡œë”© í•„ìš”í•œ ê²½ìš°ì—ë§Œ load ì´ë²¤íŠ¸ ê¸°ë‹¤ë¦¼
                viewer.addEventListener('load', () => {
                    console.log('âœ… ëª¨ë¸ ë¡œë“œ ì™„ë£Œ:', newName);
                    sendMessageToFlutter('modelLoaded', { src: newSrc, name: newName });
                }, { once: true });

                // ì—ëŸ¬ ì´ë²¤íŠ¸ ê°ì‹œ
                viewer.addEventListener('error', (event) => {
                    console.error('âŒ ëª¨ë¸ ë¡œë”© ì—ëŸ¬:', newName, event.detail);
                    sendMessageToFlutter('error', {
                        message: event.detail?.message || 'ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨',
                        src: newSrc,
                        name: newName
                    });
                }, { once: true });
            }

            // ëª¨ë¸ ì†ŒìŠ¤ ë³€ê²½
            viewer.src = finalSrc;
            viewer.alt = newName + ' 3D ëª¨ë¸';

            // ìƒíƒœ ì´ˆê¸°í™”
            currentScale = 1.0;
            currentRotationX = 0;
            hasRotated = false;
            hasZoomed = false;
            initialScale = 1.0;
            initialRotationX = 0;
        }
        
        // AR ë²„íŠ¼ ì œê±°: Flutter UIì—ì„œ ì²˜ë¦¬

        // ëª¨ë¸ ë¡œë“œ ì™„ë£Œ ì´ë²¤íŠ¸ëŠ” changeModel í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì²˜ë¦¬ë¨

        // ì—ëŸ¬ ì´ë²¤íŠ¸
        viewer.addEventListener('error', (event) => {
            sendMessageToFlutter('error', {
                message: event.detail?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
            });
        });

        // AR ìƒíƒœë¥¼ Flutterë¡œ ì „ë‹¬
        viewer.addEventListener('ar-status', (event) => {
            const status = event.detail.status;

            // Flutterë¡œ AR ìƒíƒœ ì „ë‹¬
            sendMessageToFlutter('arStatus', { status: status });

            // ìƒíƒœë³„ í”¼ë“œë°± ì „ì†¡
            if (status === 'session-started') {
                sendMessageToFlutter('arSessionStarted');
            } else if (status === 'session-ended') {
                sendMessageToFlutter('arSessionEnded');

                // AR ì„¸ì…˜ ì¢…ë£Œ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
                console.log('ğŸ”„ AR ì„¸ì…˜ ì¢…ë£Œ - ìƒíƒœ ì´ˆê¸°í™”');

                viewer.style.opacity = '1';
                isPlacementMode = false;
                isModelPlaced = false;
            }
            
            // AR ì„¸ì…˜ ì‹œì‘ ì‹œ í„°ì¹˜ ì´ë™ ì‹œìŠ¤í…œ í™œì„±í™”
            if (event.detail.status === 'session-started') {
                console.log('ğŸš€ AR ì„¸ì…˜ ì‹œì‘ë¨ - í„°ì¹˜ ì´ë™ ì‹œìŠ¤í…œ í™œì„±í™”');

                // ì´ˆê¸° ìƒíƒœ ì„¤ì •
                isPlacementMode = true;
                isModelPlaced = false;
                isPlaneDetected = false;

                // í‰ë©´ ê°ì§€ ì•Œë¦¼
                sendMessageToFlutter('planeDetectionChanged', { detected: false });

                setupARScaling();
                setupPlaneDetection();
                setupTouchMovement(); // ğŸ¯ ìƒˆë¡œìš´ í„°ì¹˜ ì´ë™ ì‹œìŠ¤í…œ

                // AR ë Œë”ë§ ìµœì í™” ì„¤ì •
                if (viewer.arSession) {
                    // ê¹Šì´ í…ŒìŠ¤íŠ¸ ê°œì„ 
                    viewer.arSession.updateRenderState({
                        depthNear: 0.1,
                        depthFar: 100
                    });

                    // ì˜¤í´ë£¨ì „ ì²˜ë¦¬ í™œì„±í™” (WebXRì—ì„œ ì§€ì› ì‹œ)
                    if (viewer.arSession.environmentBlendMode) {
                        console.log('í™˜ê²½ ë¸”ë Œë“œ ëª¨ë“œ:', viewer.arSession.environmentBlendMode);
                    }
                }
            }
        });
        
        // ë°°ì¹˜ ë²„íŠ¼ ì œê±°: Flutter UIì—ì„œ ì²˜ë¦¬

        // ëª¨ë¸ ë°°ì¹˜ í•¨ìˆ˜
        function placeModelAtPosition(x, y) {
            // ëª¨ë¸ ì™„ì „íˆ í‘œì‹œ
            viewer.style.opacity = '1';

            // ë°°ì¹˜ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
            isModelPlaced = true;
            isPlacementMode = false;

            // ë°°ì¹˜ ë²„íŠ¼ì€ Flutter UIì—ì„œ ì²˜ë¦¬

            // í–…í‹± í”¼ë“œë°± ì „ì†¡
            sendMessageToFlutter('hapticFeedback', { intensity: 'success' });

            // ë°°ì¹˜ ì™„ë£Œ ë©”ì‹œì§€
            sendMessageToFlutter('modelPlaced', { x: x, y: y });

            console.log(`ëª¨ë¸ì´ (${x}, ${y}) ìœ„ì¹˜ì— ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // ğŸš€ í„°ì¹˜ ê¸°ë°˜ ëª¨ë¸ ì´ë™ ì‹œìŠ¤í…œ
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        function setupTouchMovement() {
            console.log('ğŸ¯ í„°ì¹˜ ì´ë™ ì‹œìŠ¤í…œ ì„¤ì • ì¤‘...');

            // ëª¨ë¸ì— ë“œë˜ê·¸ í”¼ë“œë°± CSS í´ë˜ìŠ¤ ì¶”ê°€
            viewer.classList.add('drag-feedback');

            // í„°ì¹˜ ì‹œì‘ ì´ë²¤íŠ¸
            viewer.addEventListener('touchstart', (event) => {
                if (isModelPlaced && event.touches.length === 1) {
                    event.preventDefault();

                    const touch = event.touches[0];
                    dragStartX = touch.clientX;
                    dragStartY = touch.clientY;
                    isDragging = true;

                    console.log('ğŸ‘† ëª¨ë¸ ë“œë˜ê·¸ ì‹œì‘:', dragStartX, dragStartY);

                    // ë“œë˜ê·¸ ì‹œì‘ í”¼ë“œë°±
                    sendMessageToFlutter('hapticFeedback', { intensity: 'light' });
                }
            }, { passive: false });

            // í„°ì¹˜ ì´ë™ ì´ë²¤íŠ¸
            viewer.addEventListener('touchmove', (event) => {
                if (isDragging && event.touches.length === 1) {
                    event.preventDefault();

                    const touch = event.touches[0];
                    const deltaX = touch.clientX - dragStartX;
                    const deltaY = touch.clientY - dragStartY;

                    // ğŸ¯ í•µì‹¬: í„°ì¹˜ ìœ„ì¹˜ë¡œ ëª¨ë¸ ì´ë™
                    moveModelToTouchPosition(touch.clientX, touch.clientY);
                }
            }, { passive: false });

            // í„°ì¹˜ ì¢…ë£Œ ì´ë²¤íŠ¸
            viewer.addEventListener('touchend', (event) => {
                if (isDragging) {
                    isDragging = false;
                    console.log('ğŸ‘† ëª¨ë¸ ë“œë˜ê·¸ ì™„ë£Œ');

                    // ëª¨ë¸ì„ ì›ë˜ ìƒíƒœë¡œ ë³µì›
                    viewer.style.opacity = '1';
                    viewer.style.transform = 'scale(1)';

                    // ë“œë˜ê·¸ ì¸ë””ì¼€ì´í„° ì œê±°
                    if (dragIndicator) {
                        dragIndicator.remove();
                        dragIndicator = null;
                    }

                    // ë“œë˜ê·¸ ì™„ë£Œ í”¼ë“œë°±
                    sendMessageToFlutter('hapticFeedback', { intensity: 'medium' });
                    sendMessageToFlutter('modelMoved', {
                        message: 'ëª¨ë¸ì´ ìƒˆ ìœ„ì¹˜ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤'
                    });
                }
            });

            console.log('âœ… í„°ì¹˜ ì´ë™ ì‹œìŠ¤í…œ ì„¤ì • ì™„ë£Œ');
        }

        // í„°ì¹˜ ìœ„ì¹˜ë¡œ ëª¨ë¸ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function moveModelToTouchPosition(touchX, touchY) {
            try {
                // í™”ë©´ ì¢Œí‘œë¥¼ ì •ê·œí™”ëœ ì¢Œí‘œë¡œ ë³€í™˜
                const normalizedX = (touchX / window.innerWidth) * 2 - 1;
                const normalizedY = -((touchY / window.innerHeight) * 2 - 1);

                console.log('ğŸ¯ í„°ì¹˜ ìœ„ì¹˜:', touchX, touchY);

                // ğŸ¯ í•µì‹¬: ì‹œê°ì  í”¼ë“œë°±ìœ¼ë¡œ ì´ë™ íš¨ê³¼ êµ¬í˜„
                // ëª¨ë¸ì„ ì‹¤ì œë¡œëŠ” ì´ë™í•˜ì§€ ì•Šì§€ë§Œ, ì‚¬ìš©ìì—ê²Œ ì´ë™í•˜ëŠ” ëŠë‚Œì„ ì œê³µ

                // 1. í™”ë©´ ì¤‘ì•™ì—ì„œì˜ ê±°ë¦¬ ê³„ì‚°
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                const distance = Math.sqrt(
                    Math.pow(touchX - centerX, 2) + Math.pow(touchY - centerY, 2)
                );

                // 2. ê±°ë¦¬ì— ë”°ë¥¸ ì‹œê°ì  íš¨ê³¼
                if (distance > 50) { // ì¤‘ì•™ì—ì„œ 50px ì´ìƒ ë–¨ì–´ì§„ ê²½ìš°
                    // ëª¨ë¸ ì•½ê°„ íˆ¬ëª…í•˜ê²Œ (ì´ë™ ì¤‘ íš¨ê³¼)
                    viewer.style.opacity = '0.8';
                    viewer.style.transform = 'scale(0.95)'; // ì•½ê°„ ì‘ê²Œ

                    // ë“œë˜ê·¸ ë°©í–¥ ì‹œê°í™”
                    createDragIndicator(touchX, touchY);
                } else {
                    // ì›ë˜ ìƒíƒœë¡œ ë³µì›
                    viewer.style.opacity = '1';
                    viewer.style.transform = 'scale(1)';
                }

                // 3. Flutterì— í„°ì¹˜ ìœ„ì¹˜ ì •ë³´ ì „ì†¡ (UI ì—…ë°ì´íŠ¸ìš©)
                sendMessageToFlutter('modelDragging', {
                    x: touchX,
                    y: touchY,
                    distance: distance
                });

            } catch (error) {
                console.log('âš ï¸ ëª¨ë¸ ì´ë™ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        // ë“œë˜ê·¸ ë°©í–¥ ì‹œê°í™” ì¸ë””ì¼€ì´í„°
        let dragIndicator = null;

        function createDragIndicator(x, y) {
            // ê¸°ì¡´ ì¸ë””ì¼€ì´í„° ì œê±°
            if (dragIndicator) {
                dragIndicator.remove();
            }

            // ìƒˆë¡œìš´ ë“œë˜ê·¸ ì¸ë””ì¼€ì´í„° ìƒì„±
            dragIndicator = document.createElement('div');
            dragIndicator.style.position = 'absolute';
            dragIndicator.style.left = (x - 10) + 'px';
            dragIndicator.style.top = (y - 10) + 'px';
            dragIndicator.style.width = '20px';
            dragIndicator.style.height = '20px';
            dragIndicator.style.borderRadius = '50%';
            dragIndicator.style.backgroundColor = 'rgba(0, 60, 122, 0.7)';
            dragIndicator.style.border = '2px solid white';
            dragIndicator.style.pointerEvents = 'none';
            dragIndicator.style.zIndex = '1000';
            dragIndicator.style.animation = 'pulse 0.5s ease-in-out infinite alternate';

            document.body.appendChild(dragIndicator);

            // 0.5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (dragIndicator) {
                    dragIndicator.remove();
                    dragIndicator = null;
                }
            }, 500);
        }

        // í‰ë©´ ê°ì§€ ì„¤ì •
        function setupPlaneDetection() {
            if (!viewer.arSession) {
                console.log('âš ï¸ AR ì„¸ì…˜ì´ ì—†ì–´ì„œ í‰ë©´ ê°ì§€ë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            console.log('ğŸ” í‰ë©´ ê°ì§€ ì„¤ì • ì‹œì‘');

            // ì •ê¸°ì ìœ¼ë¡œ í‰ë©´ ê°ì§€ ìƒíƒœ í™•ì¸
            const planeDetectionInterval = setInterval(() => {
                if (!isPlacementMode || isModelPlaced) {
                    clearInterval(planeDetectionInterval);
                    return;
                }

                checkForPlanes();
            }, 500); // 0.5ì´ˆë§ˆë‹¤ í™•ì¸
        }

        // í‰ë©´ í™•ì¸ í•¨ìˆ˜
        function checkForPlanes() {
            if (!viewer.arSession) return;

            // WebXRì—ì„œ í‰ë©´ ê°ì§€ í™•ì¸ (ì‹¤ì œë¡œëŠ” ë³µì¡í•˜ì§€ë§Œ ê°„ë‹¨í•œ ê·¼ì‚¬ì¹˜ ì‚¬ìš©)
            const frame = viewer.arSession.requestAnimationFrame ? viewer.arSession.requestAnimationFrame() : null;

            // ì‹¤ì œ í‰ë©´ ê°ì§€ëŠ” ë³µì¡í•˜ë¯€ë¡œ, ê°„ë‹¨í•œ timeout ê¸°ë°˜ ì‹œë®¬ë ˆì´ì…˜ ì‚¬ìš©
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” hit-test APIë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
            setTimeout(() => {
                // 3ì´ˆ í›„ í‰ë©´ì´ ê°ì§€ëœ ê²ƒìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜
                if (isPlacementMode && !isModelPlaced && !isPlaneDetected) {
                    console.log('âœ… í‰ë©´ ê°ì§€ë¨');
                    isPlaneDetected = true;
                    sendMessageToFlutter('planeDetectionChanged', {
                        detected: true,
                        message: 'í‰ë©´ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ìœ„ì¹˜ì— ë°°ì¹˜í•˜ì„¸ìš”.'
                    });
                }
            }, 3000);
        }

        // AR ëª¨ë“œì—ì„œ ìŠ¤ì¼€ì¼ ë° íšŒì „ ì„¤ì •
        function setupARScaling() {
            // WebXR ì„¸ì…˜ì—ì„œ ìŠ¤ì¼€ì¼ ì´ë²¤íŠ¸ ì²˜ë¦¬
            if (viewer.arSession) {
                // í„°ì¹˜ ì´ë²¤íŠ¸ë¡œ ì§ì ‘ ìŠ¤ì¼€ì¼ ì²˜ë¦¬
                viewer.addEventListener('touchstart', handleTouchStart, { passive: false });
                viewer.addEventListener('touchmove', handleTouchMove, { passive: false });
                viewer.addEventListener('touchend', handleTouchEnd, { passive: false });
            }
        }
        
        // íšŒì „ ê´€ë ¨ ë³€ìˆ˜
        let isRotating = false;
        let lastTouchY = 0;
        let currentRotationX = 0;

        // ì œìŠ¤ì²˜ íŒíŠ¸ ì¶”ì  ë³€ìˆ˜
        let hasRotated = false;
        let hasZoomed = false;
        let rotationThreshold = 20; // 20ë„ ì´ìƒ íšŒì „ ì‹œ ì™„ë£Œë¡œ ê°„ì£¼
        let zoomThreshold = 0.2; // 20% ì´ìƒ ìŠ¤ì¼€ì¼ ë³€ê²½ ì‹œ ì™„ë£Œë¡œ ê°„ì£¼
        let initialScale = 1.0;
        let initialRotationX = 0;
        
        // í„°ì¹˜ ì‹œì‘
        function handleTouchStart(e) {
            // í„°ì¹˜ í¬ì¸íŠ¸ì— ì‹œê°ì  í”¼ë“œë°±
            const touch = e.touches[0];
            createModelHighlight(touch.clientX, touch.clientY);

            // ğŸ¯ í„°ì¹˜ ì‹œ Ground Plane í‘œì‹œ (í…ŒìŠ¤íŠ¸ìš© - AR ì²´í¬ ì œê±°)
            console.log('ğŸ” í„°ì¹˜ ì´ë²¤íŠ¸ ë°œìƒ, Ground Plane í˜¸ì¶œ');
            showGroundPlane();

            // Flutterë¡œ ëª¨ë¸ í„°ì¹˜ ì•Œë¦¼
            sendMessageToFlutter('modelTouched', {
                x: touch.clientX,
                y: touch.clientY
            });

            if (e.touches.length === 1) {
                // í•œ ì†ê°€ë½ í„°ì¹˜ - íšŒì „ ì‹œì‘
                isRotating = true;
                lastTouchY = e.touches[0].clientY;

                // ì œìŠ¤ì²˜ ì‹œì‘ ì•Œë¦¼
                sendMessageToFlutter('gestureStart', { type: 'rotate' });

                // ì´ˆê¸° íšŒì „ê°’ ì €ì¥
                if (!hasRotated) {
                    initialRotationX = currentRotationX;
                }
            } else if (e.touches.length === 2) {
                // ë‘ ì†ê°€ë½ í„°ì¹˜ - í•€ì¹˜ ì‹œì‘
                isRotating = false;
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );

                // ì œìŠ¤ì²˜ ì‹œì‘ ì•Œë¦¼
                sendMessageToFlutter('gestureStart', { type: 'pinch' });

                // ì´ˆê¸° ìŠ¤ì¼€ì¼ê°’ ì €ì¥
                if (!hasZoomed) {
                    initialScale = currentScale;
                }
            }
        }
        
        // í„°ì¹˜ ì´ë™
        function handleTouchMove(e) {
            e.preventDefault();
            
            if (e.touches.length === 1 && isRotating) {
                // í•œ ì†ê°€ë½ ë“œë˜ê·¸ - Xì¶• íšŒì „ë§Œ
                const deltaY = e.touches[0].clientY - lastTouchY;
                
                // Xì¶• íšŒì „ (ìƒí•˜ ë“œë˜ê·¸) - ì œí•œ ì ìš©
                currentRotationX -= deltaY * 0.5; // ìœ„ë¡œ ë“œë˜ê·¸í•˜ë©´ ìœ„ë¡œ íšŒì „
                currentRotationX = Math.max(-60, Math.min(60, currentRotationX)); // -60ë„ ~ +60ë„
                
                // ëª¨ë¸ì— íšŒì „ ì ìš©
                if (viewer.model) {
                    const model = viewer.model;
                    model.rotation = `${currentRotationX}deg 0deg 0deg`;
                }

                lastTouchY = e.touches[0].clientY;

                // íšŒì „ ì œìŠ¤ì²˜ ì™„ë£Œ ì²´í¬
                if (!hasRotated && Math.abs(currentRotationX - initialRotationX) >= rotationThreshold) {
                    hasRotated = true;
                    sendMessageToFlutter('rotation', {
                        totalRotation: Math.abs(currentRotationX - initialRotationX)
                    });
                }
                
            } else if (e.touches.length === 2 && !isRotating) {
                // ë‘ ì†ê°€ë½ í•€ì¹˜ - ìŠ¤ì¼€ì¼ ì¡°ì ˆ
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                if (lastTouchDistance > 0) {
                    const scaleDelta = currentDistance / lastTouchDistance;
                    currentScale *= scaleDelta;
                    currentScale = Math.max(0.1, Math.min(5.0, currentScale)); // 10% ~ 500% ì œí•œ
                    
                    // ëª¨ë¸ ìŠ¤ì¼€ì¼ ì ìš©
                    if (viewer.model) {
                        viewer.model.scale = `${currentScale} ${currentScale} ${currentScale}`;
                    }
                }

                lastTouchDistance = currentDistance;

                // í™•ëŒ€/ì¶•ì†Œ ì œìŠ¤ì²˜ ì™„ë£Œ ì²´í¬
                if (!hasZoomed && Math.abs(currentScale - initialScale) >= zoomThreshold) {
                    hasZoomed = true;
                    sendMessageToFlutter('zoom', {
                        totalScaleChange: Math.abs(currentScale - initialScale),
                        finalScale: currentScale
                    });
                }
            }
        }
        
        // í„°ì¹˜ ì¢…ë£Œ
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                lastTouchDistance = 0;
                // ìŠ¤ì¼€ì¼ ë° íšŒì „ ê°’ ìœ ì§€ (ì›ìƒë³µê·€í•˜ì§€ ì•ŠìŒ)
                console.log('í˜„ì¬ ìŠ¤ì¼€ì¼:', currentScale, 'Xì¶• íšŒì „:', currentRotationX);

                // ì œìŠ¤ì²˜ ì¢…ë£Œ ì•Œë¦¼
                sendMessageToFlutter('gestureEnd', {
                    scale: currentScale,
                    rotation: currentRotationX
                });
            }
            if (e.touches.length === 0) {
                isRotating = false;
            }
        }
        
        // 3D ë·°ì–´ ëª¨ë“œì—ì„œë„ ìŠ¤ì¼€ì¼ ìœ ì§€
        viewer.addEventListener('camera-change', (event) => {
            // ì¹´ë©”ë¼ ë³€ê²½ ì‹œì—ë„ ìŠ¤ì¼€ì¼ ìœ ì§€
            if (!viewer.arSession && currentScale !== 1.0) {
                viewer.scale = `${currentScale} ${currentScale} ${currentScale}`;
            }
        });

        // ì¶”ê°€ Model Viewer ì´ë²¤íŠ¸ë“¤
        viewer.addEventListener('interaction-prompt', (event) => {
            sendMessageToFlutter('interactionPrompt', {
                status: event.detail.visible
            });
        });

        viewer.addEventListener('play', (event) => {
            sendMessageToFlutter('animationPlay');
        });

        viewer.addEventListener('pause', (event) => {
            sendMessageToFlutter('animationPause');
        });

        // Flutter ì˜¤ë²„ë ˆì´ ë°©ì‹ìœ¼ë¡œ ë³€ê²½ - ë³µì¡í•œ í„°ì¹˜ ì°¨ë‹¨ ë¡œì§ ì œê±°ë¨

        // ê°„ë‹¨í•œ í„°ì¹˜ ë¦¬í”Œ íš¨ê³¼ (Flutter ì˜¤ë²„ë ˆì´ì™€ ì¶©ëŒ ì—†ìŒ)
        document.addEventListener('touchstart', (event) => {
            const viewerRect = viewer.getBoundingClientRect();
            const touch = event.touches[0];

            if (touch.clientX >= viewerRect.left &&
                touch.clientX <= viewerRect.right &&
                touch.clientY >= viewerRect.top &&
                touch.clientY <= viewerRect.bottom) {
                createTouchRipple(touch.clientX, touch.clientY);
            }
        }, { passive: true });

        // ì´ˆê¸°í™” ì™„ë£Œ ì•Œë¦¼
        window.addEventListener('load', () => {
            sendMessageToFlutter('htmlLoaded');
            console.log('Model Viewer HTML ë¡œë”© ì™„ë£Œ');

            // ğŸ” í…ŒìŠ¤íŠ¸: í˜ì´ì§€ ë¡œë“œ 3ì´ˆ í›„ Ground Plane í‘œì‹œ
            setTimeout(() => {
                console.log('ğŸ§ª í…ŒìŠ¤íŠ¸: ìë™ìœ¼ë¡œ Ground Plane í‘œì‹œ ì‹œë„');
                showGroundPlane();
            }, 3000);
        });
    </script>
</body>
</html>