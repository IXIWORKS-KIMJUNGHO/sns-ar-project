<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onnuri AR - ì˜¨ëˆ„ë¦¬ êµíšŒ ì²´í—˜</title>

    <!-- iOS ì „ì²´ í™”ë©´ ëª¨ë“œ (PWA Standalone) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Onnuri AR">

    <!-- AR.js + Three.js (ì§€ì—° ë¡œë“œ) -->
    <script defer src="https://cdn.jsdelivr.net/npm/three@0.180.0/build/three.min.js"></script>
    <script defer src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar.js"></script>

    <!-- model-viewer (ëª¨ë“ˆì€ ìë™ defer) -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>

    <!-- Phosphor Icons (í•„ìˆ˜ - ì˜¨ë³´ë”© ì•„ì´ì½˜ìš©) -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3"></script>

    <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <!-- Design System (ì¸ë¼ì¸ìœ¼ë¡œ ë³€ê²½) -->

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: var(--font-primary);
            width: 100%;
            height: 100%;
        }

        #ar-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* ë¡œë”© í™”ë©´ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ - ì˜¨ë³´ë”© ì™„ë£Œ í›„ í‘œì‹œ */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            padding: 20px;
            overflow-y: auto; /* ê°€ì´ë“œ ì½˜í…ì¸ ë¥¼ ìœ„í•œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
        }

        #loading-screen h2 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--spacing-lg);
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        #loading-screen p {
            font-size: var(--font-size-base);
            margin-bottom: var(--spacing-sm);
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-top: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ë””ë²„ê·¸ ì •ë³´ */
        #debugInfo {
            position: fixed;
            top: var(--spacing-lg);
            left: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--overlay-darkest);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            z-index: 9999;
            pointer-events: none;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        /* AR ëª¨ë“œ ì¸ë””ì¼€ì´í„° - ì œê±°ë¨ */
        #mode-indicator {
            display: none;
        }

        /* ì˜¨ë³´ë”© ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ - ì œê±°ë¨ */
        #replay-onboarding-btn {
            display: none;
        }
    </style>
</head>
<body>

    <!-- ì˜¨ë³´ë”© ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ -->
    <button id="replay-onboarding-btn"><i class="ph-bold ph-book-open"></i> ì‚¬ìš©ë²• ë‹¤ì‹œë³´ê¸°</button>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading-screen">
        <h2><i class="ph-bold ph-church"></i> Onnuri AR</h2>
        <p id="loading-message">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</p>
        <div class="spinner"></div>
    </div>

    <!-- AR ì»¨í…Œì´ë„ˆ -->
    <div id="ar-container"></div>

    <!-- ë””ë²„ê·¸ ì •ë³´ -->
    <div id="debugInfo">AR ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘...</div>

    <!-- AR ëª¨ë“œ ì¸ë””ì¼€ì´í„° -->
    <div id="mode-indicator">í”Œë«í¼ ê°ì§€ ì¤‘...</div>

    <!-- ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { platformDetector } from './src/platform-detector.js';
        import { OnboardingScreen } from './src/onboarding-screen.js';
        import { CameraPermissionScreen } from './src/camera-permission-screen.js';

        let currentMode = null;
        let arApp = null;
        let onboarding = null;
        let cameraPermission = null;

        /**
         * WebView ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ (Promise ë°˜í™˜)
         */
        function showWebViewWarning(appName) {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.id = 'webview-warning';
                overlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.95); z-index: 200000;
                    display: flex; align-items: center; justify-content: center;
                    padding: 20px; font-family: var(--font-primary);
                `;
                overlay.innerHTML = `
                    <div style="max-width: 400px; text-align: center; color: white;">
                        <i class="ph-fill ph-warning-circle" style="font-size: 64px; color: #FFC107;"></i>
                        <h2 style="margin-top: 24px; font-size: 22px; font-weight: bold;">
                            ${appName}ì—ì„œëŠ”<br>AR ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤
                        </h2>
                        <p style="margin-top: 20px; font-size: 16px; line-height: 1.6; opacity: 0.9;">
                            ìµœìƒì˜ AR ì²´í—˜ì„ ìœ„í•´<br>
                            <strong>Chrome ë˜ëŠ” Safari</strong> ë¸Œë¼ìš°ì €ë¡œ ì—´ì–´ì£¼ì„¸ìš”
                        </p>
                        <div style="margin-top: 16px; padding: 16px; background: rgba(255,193,7,0.2); border-radius: 12px; font-size: 14px;">
                            <i class="ph-bold ph-info"></i> ìš°ì¸¡ ìƒë‹¨ [...] ë©”ë‰´ â†’ "ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°"
                        </div>
                        <div style="margin-top: 24px; display: flex; gap: 12px;">
                            <button id="webview-continue" style="flex: 1; padding: 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 12px; font-size: 16px; font-weight: bold;">
                                ê·¸ëƒ¥ ê³„ì†
                            </button>
                            <button id="webview-guide" style="flex: 1; padding: 16px; background: var(--color-accent); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold;">
                                ì—¬ëŠ” ë°©ë²•
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);

                document.getElementById('webview-continue').onclick = () => {
                    overlay.remove();
                    resolve(true);
                };

                document.getElementById('webview-guide').onclick = () => {
                    overlay.remove();
                    resolve(false);
                };
            });
        }

        /**
         * WebView ê°€ì´ë“œ ì „ì²´ í™”ë©´
         */
        function showWebViewGuide(appName) {
            document.body.innerHTML = `
                <div style="padding: 40px 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; font-family: var(--font-primary);">
                    <i class="ph-fill ph-browsers" style="font-size: 80px;"></i>
                    <h2 style="margin-top: 24px; font-size: 26px; font-weight: bold;">AR ì²´í—˜ì„ ìœ„í•´<br>ë¸Œë¼ìš°ì €ë¡œ ì—´ì–´ì£¼ì„¸ìš”</h2>

                    <div style="margin-top: 32px; background: rgba(255,255,255,0.15); padding: 28px; border-radius: 20px; text-align: left; backdrop-filter: blur(10px);">
                        <h3 style="margin-bottom: 20px; font-size: 18px;">
                            <i class="ph-bold ph-number-circle-one"></i> ${appName}ì—ì„œ ë¸Œë¼ìš°ì €ë¡œ ì—¬ëŠ” ë°©ë²•
                        </h3>
                        <ol style="line-height: 2.2; font-size: 16px; padding-left: 24px;">
                            <li>í™”ë©´ ìš°ì¸¡ ìƒë‹¨ <strong>[...]</strong> ë˜ëŠ” <strong>[â‹®]</strong> ë©”ë‰´ í´ë¦­</li>
                            <li><strong>"ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°"</strong> ë˜ëŠ”<br><strong>"Safarië¡œ ì—´ê¸°"</strong> ì„ íƒ</li>
                            <li>AR ì²´í—˜ ì‹œì‘! ğŸ‰</li>
                        </ol>
                    </div>

                    <div style="margin-top: 24px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 16px; font-size: 14px;">
                        <i class="ph-bold ph-lightbulb"></i> ë¸Œë¼ìš°ì €ì—ì„œ QR ìŠ¤ìº” ë° AR ëª¨ë¸ ë°°ì¹˜ê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤
                    </div>

                    <button onclick="location.reload()" style="margin-top: 32px; padding: 18px 36px; background: white; color: #667eea; border: none; border-radius: 16px; font-size: 18px; font-weight: bold;">
                        <i class="ph-bold ph-arrow-clockwise"></i> ë‹¤ì‹œ ì‹œë„í•˜ê¸°
                    </button>
                </div>
            `;
        }

        /**
         * Chrome ì—…ë°ì´íŠ¸ í•„ìš” ì „ì²´ í™”ë©´
         */
        function showChromeUpdateWarning(version) {
            document.body.innerHTML = `
                <div style="padding: 40px 20px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; font-family: var(--font-primary);">
                    <i class="ph-fill ph-warning-circle" style="font-size: 80px; color: #FFC107;"></i>
                    <h2 style="margin-top: 24px; font-size: 26px; font-weight: bold;">Chrome ì—…ë°ì´íŠ¸ í•„ìš”</h2>

                    <div style="margin-top: 32px; background: rgba(255,255,255,0.15); padding: 28px; border-radius: 20px; backdrop-filter: blur(10px);">
                        <p style="font-size: 18px; margin-bottom: 24px;">
                            AR ê¸°ëŠ¥ ì‚¬ìš©ì„ ìœ„í•´<br>
                            <strong>Chrome 90 ì´ìƒ</strong> í•„ìš”
                        </p>
                        <div style="display: flex; justify-content: space-around;">
                            <div>
                                <div style="font-size: 14px; opacity: 0.8;">í˜„ì¬</div>
                                <div style="font-size: 32px; font-weight: bold; color: #FFC107;">v${version}</div>
                            </div>
                            <div style="font-size: 32px;">â†’</div>
                            <div>
                                <div style="font-size: 14px; opacity: 0.8;">í•„ìš”</div>
                                <div style="font-size: 32px; font-weight: bold; color: #00D9A0;">v90+</div>
                            </div>
                        </div>
                    </div>

                    <button onclick="window.open('https://play.google.com/store/apps/details?id=com.android.chrome', '_blank')" style="margin-top: 32px; padding: 18px 36px; background: white; color: #667eea; border: none; border-radius: 16px; font-size: 18px; font-weight: bold;">
                        <i class="ph-bold ph-google-chrome-logo"></i> Chrome ì—…ë°ì´íŠ¸
                    </button>

                    <button onclick="location.reload()" style="margin-top: 16px; padding: 16px 32px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 16px; font-size: 16px;">
                        ë‹¤ì‹œ ì‹œë„
                    </button>
                </div>
            `;
        }

        /**
         * í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° (ê¸€ë¡œë²Œ í•¨ìˆ˜)
         */
        window.returnToHome = function() {
            console.log('[Main] ğŸ  Returning to home...');

            // 1. ëª¨ë“  AR ìš”ì†Œ ì •ë¦¬
            const modelViewer = document.getElementById('ar-model-viewer');
            const arButton = document.getElementById('custom-ar-button');
            const closeBtn = document.getElementById('model-viewer-close-btn');
            const qrUI = document.getElementById('qr-scanner-ui');
            const loadingScreen = document.getElementById('loading-screen');

            if (modelViewer) modelViewer.style.display = 'none';
            if (arButton) arButton.remove();
            if (closeBtn) closeBtn.remove();
            if (qrUI) qrUI.remove();
            if (loadingScreen) loadingScreen.style.display = 'none';

            // 2. ì˜¨ë³´ë”© í™ˆ í™”ë©´ í‘œì‹œ
            if (onboarding) {
                onboarding.showHome();
            }

            console.log('[Main] âœ… Returned to home');
        };

        async function init() {
            console.log('[Main] ğŸš€ Onnuri AR ì‹œì‘...');

            // 0. WebView ë° Chrome ë²„ì „ ì²´í¬ ë¨¼ì €
            const platform = platformDetector.platform;

            // WebView ê°ì§€ ì‹œ ê²½ê³ 
            if (platform.isWebView) {
                const appName = platformDetector.getWebViewAppName();
                const shouldContinue = await showWebViewWarning(appName);

                if (!shouldContinue) {
                    showWebViewGuide(appName);
                    return;
                }
            }

            // Android Chrome ë²„ì „ ì²´í¬
            if (platform.isAndroid && platform.isChrome && !platformDetector.isChromeSufficient()) {
                const version = platformDetector.getChromeVersion();
                showChromeUpdateWarning(version);
                return;
            }

            // 1. ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
            cameraPermission = new CameraPermissionScreen();
            const permissionGranted = await cameraPermission.show();

            if (!permissionGranted) {
                console.log('[Main] âŒ Camera permission denied - App blocked');
                return;
            }

            console.log('[Main] âœ… Camera permission granted - Starting app');

            // 2. ì˜¨ë³´ë”© ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            onboarding = new OnboardingScreen();

            // 3. ì˜¨ë³´ë”© í•­ìƒ í‘œì‹œ
            onboarding.show(() => {
                console.log('[Main] Onboarding complete, starting AR...');

                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'flex';
                }

                startARSystem(true);
            });

            setupReplayButton();
        }

        /**
         * ì˜¨ë³´ë”© ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ ì„¤ì • (ì˜¨ë³´ë”©ì´ í•­ìƒ í‘œì‹œë˜ë¯€ë¡œ ë¶ˆí•„ìš”)
         */
        function setupReplayButton() {
            // ì˜¨ë³´ë”©ì´ í•­ìƒ í‘œì‹œë˜ë¯€ë¡œ ë‹¤ì‹œë³´ê¸° ë²„íŠ¼ì€ ì œê±°
            const replayBtn = document.getElementById('replay-onboarding-btn');
            if (replayBtn) {
                replayBtn.remove();
            }
        }

        async function startARSystem(autoStartAR = false) {
            // í”Œë«í¼ ê°ì§€
            updateLoadingMessage('í”Œë«í¼ ë¶„ì„ ì¤‘...');
            const platformInfo = platformDetector.getPlatformInfo();
            console.log('[Main] Platform:', platformInfo);

            // ìµœì  ëª¨ë“œ ê²°ì •
            currentMode = await detectBestMode();
            console.log('[Main] Selected mode:', currentMode);

            // ëª¨ë“œë³„ ì´ˆê¸°í™”
            if (currentMode === 'android-webxr') {
                await initAndroidMode();
            } else if (currentMode === 'ios-quicklook') {
                await initIOSMode(autoStartAR);
            } else {
                await initFallbackMode();
            }

            // ë¡œë”© í™”ë©´ ìˆ¨ê¹€
            setTimeout(() => {
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }, 1000);
        }

        /**
         * ìµœì  ëª¨ë“œ ê°ì§€
         */
        async function detectBestMode() {
            const platform = platformDetector.platform;

            // iOS ëª¨ë“  ë¸Œë¼ìš°ì € â†’ AR Quick Look
            // (iOSì˜ ëª¨ë“  ë¸Œë¼ìš°ì €ëŠ” WebKit ê¸°ë°˜ìœ¼ë¡œ AR Quick Look ì§€ì›)
            if (platform.isIOS) {
                return 'ios-quicklook';
            }

            // Android Chrome + WebXR ì§€ì› â†’ WebXR + QR
            if (platform.isAndroid && platform.isChrome) {
                const supportsWebXR = await platformDetector.checkWebXRSupport();
                if (supportsWebXR) {
                    return 'android-webxr';
                }
            }

            // ê¸°íƒ€ â†’ AR.js í´ë°±
            return 'fallback-arjs';
        }

        /**
         * Android ëª¨ë“œ: AR.js QR + WebXR Anchor
         */
        async function initAndroidMode() {
            console.log('[Main] Android WebXR + QR ëª¨ë“œ');

            updateLoadingMessage('<i class="ph-bold ph-android-logo"></i> Android AR ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            updateModeIndicator('<i class="ph-bold ph-android-logo"></i> Android (WebXR + QR)', 'rgba(76,175,80,0.95)');

            const container = document.getElementById('ar-container');
            arApp = new AndroidQRAnchoring(container);

            try {
                await arApp.start();
                updateDebugInfo('âœ… Android AR ì¤€ë¹„ ì™„ë£Œ! QR ë§ˆì»¤ë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”.');
            } catch (error) {
                console.error('[Main] âŒ Android mode failed:', error);
                updateDebugInfo('âš ï¸ Android AR ì´ˆê¸°í™” ì‹¤íŒ¨. AR.js í´ë°±ìœ¼ë¡œ ì „í™˜ ì¤‘...');
                await initFallbackMode();
            }
        }

        /**
         * iOS/Android í†µí•© ëª¨ë“œ: model-viewer with Pre-AR Guide
         */
        async function initIOSMode(autoStartAR = false) {
            const isIOS = platformDetector.isIOS();
            const platform = isIOS ? 'iOS' : 'Android';
            const platformIcon = isIOS ? '<i class="ph-bold ph-apple-logo"></i>' : '<i class="ph-bold ph-android-logo"></i>';

            console.log(`[Main] ${platform} model-viewer + Pre-AR ê°€ì´ë“œ ëª¨ë“œ`);

            updateLoadingMessage(`${platformIcon} ${platform} AR ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...`);
            updateModeIndicator(`${platformIcon} ${platform} (QR + model-viewer AR)`, 'rgba(102,126,234,0.95)');

            // model-viewer import
            const { modelViewerAR } = await import('./src/model-viewer-ar-manager.js');

            // model-viewer ì´ˆê¸°í™” (ê¸°ë³¸ ëª¨ë¸ë¡œ ì´ˆê¸°í™”, QR ìŠ¤ìº” ì‹œ ë™ì  ë³€ê²½)
            modelViewerAR.initialize();

            // QR ìŠ¤ìºë„ˆ ì‹œì‘
            const { IOSQRScanner } = await import('./src/ios-qr-scanner.js');
            const qrScanner = new IOSQRScanner();

            const container = document.getElementById('ar-container');

            // QR ê°ì§€ ì‹œ ì²´í¬ë§ˆí¬ â†’ 3D ë·°ì–´ í‘œì‹œ
            qrScanner.onQRFound = (qrLocation, photoDataURL) => {
                console.log('[Main] QR found, showing 3D model viewer...');

                // 3D ëª¨ë¸ ë·°ì–´ í‘œì‹œ (ì»¤ìŠ¤í…€ AR ë²„íŠ¼ í¬í•¨)
                modelViewerAR.showModelViewer(qrLocation, photoDataURL);
            };

            // QR ìŠ¤ìºë„ˆ ì‹œì‘
            if (autoStartAR) {
                await qrScanner.start(container);
                updateDebugInfo('âœ… QR ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”');
            } else {
                updateDebugInfo(`âœ… ${platform} AR ì¤€ë¹„ ì™„ë£Œ!`);
            }

            // arAppì— QR ìŠ¤ìºë„ˆ ì €ì¥ (cleanupìš©)
            arApp = qrScanner;
        }

        /**
         * í´ë°± ëª¨ë“œ: AR.jsë§Œ
         */
        async function initFallbackMode() {
            console.log('[Main] AR.js í´ë°± ëª¨ë“œ');

            updateLoadingMessage('<i class="ph-bold ph-device-mobile"></i> ê¸°ë³¸ AR ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...');
            updateModeIndicator('<i class="ph-bold ph-device-mobile"></i> ê¸°ë³¸ ëª¨ë“œ (AR.js)', 'rgba(255,152,0,0.95)');

            // AR.js ê¸°ë³¸ êµ¬í˜„ (ì¶”í›„ êµ¬í˜„)
            updateDebugInfo('âš ï¸ ê¸°ë³¸ AR ëª¨ë“œëŠ” ê³§ ì§€ì›ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        /**
         * UI ì—…ë°ì´íŠ¸ í—¬í¼
         */
        function updateLoadingMessage(message) {
            const el = document.getElementById('loading-message');
            if (el) el.textContent = message;
        }

        function updateDebugInfo(message) {
            const el = document.getElementById('debugInfo');
            if (el) el.textContent = message;
        }

        function updateModeIndicator(text, color) {
            // ëª¨ë“œ ì¸ë””ì¼€ì´í„° ì œê±°ë¨ - í•¨ìˆ˜ëŠ” ìœ ì§€ (í˜¸ì¶œ ì œê±°í•˜ì§€ ì•Šê¸° ìœ„í•´)
            // const el = document.getElementById('mode-indicator');
            // if (el) {
            //     el.textContent = text;
            //     el.style.background = color;
            // }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            console.log('[Main] ğŸš€ Page loaded, starting initialization...');
            init();
        });
    </script>
</body>
</html>