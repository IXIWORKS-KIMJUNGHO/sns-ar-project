<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¨ëˆ„ë¦¬êµíšŒ AR - Flutter í†µí•©</title>

    <!-- Google Model Viewer -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        /* Flutter WebViewì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìµœì í™”ëœ ìŠ¤íƒ€ì¼ */
        .flutter-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        model-viewer {
            width: 100%;
            flex: 1;
            --poster-color: transparent;
        }

        /* Flutter ë©”ì‹œì§€ ìƒíƒœ í‘œì‹œ */
        .flutter-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        .flutter-status.connected {
            background: rgba(76, 175, 80, 0.8);
        }

        /* ê°„ì†Œí™”ëœ AR ì»¨íŠ¸ë¡¤ (Flutterì—ì„œ ì œì–´) */
        .ar-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .ar-button {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 12px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ar-button:hover {
            background: rgba(255,255,255,0.25);
        }

        .ar-button.hidden {
            display: none;
        }

        /* ë°°ì¹˜ ê´€ë ¨ UI - ìµœì†Œí™” */
        .placement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }

        .hit-indicator {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            background: rgba(76, 175, 80, 0.3);
            transform: translate(-50%, -50%);
            animation: hitPulse 1.5s infinite;
        }

        @keyframes hitPulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.7; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* ê°„ë‹¨í•œ ìƒíƒœ ë©”ì‹œì§€ */
        .status-message {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 12px;
            display: none;
            z-index: 1001;
        }

        .status-message.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body>
    <div class="flutter-container">
        <div class="header">
            <h1>ğŸ›ï¸ ì˜¨ëˆ„ë¦¬êµíšŒ AR</h1>
        </div>

        <model-viewer
            id="church-model"
            src="assets/models/church-model.glb"
            alt="ì˜¨ëˆ„ë¦¬êµíšŒ 3D ëª¨ë¸"
            camera-controls
            touch-action="pan-y"
            ar
            ar-modes="webxr scene-viewer quick-look"
            ar-scale="fixed"
            ar-placement="none"
            shadow-intensity="1"
            exposure="1">

            <button slot="ar-button" style="display: none;"></button>
        </model-viewer>

        <!-- Flutter ì—°ê²° ìƒíƒœ -->
        <div id="flutter-status" class="flutter-status">
            ğŸ“± Flutter ì—°ê²°ë¨
        </div>

        <!-- AR ì»¨íŠ¸ë¡¤ (Flutterì—ì„œ ìˆ¨ê¸¸ ìˆ˜ ìˆìŒ) -->
        <div id="ar-controls" class="ar-controls">
            <button id="start-ar-btn" class="ar-button">
                ğŸ“± AR ì‹œì‘
            </button>
        </div>

        <!-- ë°°ì¹˜ ì˜¤ë²„ë ˆì´ -->
        <div id="placement-overlay" class="placement-overlay"></div>

        <!-- ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="status-message" class="status-message"></div>
    </div>

    <script>
        class FlutterARBridge {
            constructor() {
                this.modelViewer = document.getElementById('church-model');
                this.startArBtn = document.getElementById('start-ar-btn');
                this.flutterStatus = document.getElementById('flutter-status');
                this.placementOverlay = document.getElementById('placement-overlay');
                this.statusMessage = document.getElementById('status-message');

                // ìƒíƒœ ê´€ë¦¬
                this.isARActive = false;
                this.isPlacementMode = false;
                this.isFlutterConnected = false;
                this.hitTestPoints = [];

                this.init();
            }

            init() {
                // Flutter ì—°ê²° ê°ì§€
                this.detectFlutterConnection();

                // ê¸°ë³¸ ì´ë²¤íŠ¸ ì„¤ì •
                this.startArBtn.addEventListener('click', () => {
                    this.startAR();
                });

                // Model Viewer ì´ë²¤íŠ¸
                this.modelViewer.addEventListener('ar-status', (event) => {
                    this.handleARStatus(event.detail.status);
                });

                // ë°°ì¹˜ë¥¼ ìœ„í•œ í„°ì¹˜ ì´ë²¤íŠ¸
                this.modelViewer.addEventListener('click', (event) => {
                    if (this.isPlacementMode) {
                        this.handlePlacementTouch(event);
                    }
                });

                // Flutter ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                this.setupFlutterMessageHandlers();

                console.log('âœ… Flutter AR Bridge Initialized');
            }

            detectFlutterConnection() {
                // Flutter WebView í™˜ê²½ ê°ì§€
                if (window.flutter_inappwebview || window.flutter || navigator.userAgent.includes('Flutter')) {
                    this.isFlutterConnected = true;
                    this.flutterStatus.classList.add('connected');
                    this.flutterStatus.style.display = 'block';
                    this.sendToFlutter('bridge_connected', { status: 'ready' });
                } else {
                    // ì›¹ ë¸Œë¼ìš°ì €ì—ì„œì˜ í…ŒìŠ¤íŠ¸ í™˜ê²½
                    setTimeout(() => {
                        this.isFlutterConnected = true;
                        this.flutterStatus.classList.add('connected');
                        this.flutterStatus.style.display = 'block';
                        console.log('ğŸ”§ Test mode - Flutter bridge simulated');
                    }, 1000);
                }
            }

            setupFlutterMessageHandlers() {
                // Flutter â†’ WebView ë©”ì‹œì§€ ìˆ˜ì‹ 
                window.addEventListener('message', (event) => {
                    this.handleFlutterMessage(event.data);
                });

                // Flutter InAppWebView í•¸ë“¤ëŸ¬
                if (window.flutter_inappwebview) {
                    window.flutter_inappwebview.callHandler = (action, data) => {
                        this.handleFlutterAction(action, data);
                    };
                }
            }

            handleFlutterMessage(messageData) {
                try {
                    const message = typeof messageData === 'string' ? JSON.parse(messageData) : messageData;
                    this.handleFlutterAction(message.action, message.data);
                } catch (error) {
                    console.error('Flutter message parsing error:', error);
                }
            }

            handleFlutterAction(action, data) {
                console.log(`ğŸ“± Flutter Action: ${action}`, data);

                switch (action) {
                    case 'start_ar':
                        this.startAR();
                        break;
                    case 'enable_placement':
                        this.enablePlacementMode();
                        break;
                    case 'disable_placement':
                        this.disablePlacementMode();
                        break;
                    case 'reset_ar':
                        this.resetAR();
                        break;
                    case 'hide_controls':
                        this.hideControls();
                        break;
                    case 'show_controls':
                        this.showControls();
                        break;
                    case 'update_model':
                        this.updateModel(data.modelUrl);
                        break;
                    case 'simulate_placement':
                        this.simulatePlacement(data.x, data.y);
                        break;
                }
            }

            sendToFlutter(action, data = {}) {
                const message = {
                    action: action,
                    data: data,
                    timestamp: Date.now()
                };

                // Flutter InAppWebViewë¡œ ë©”ì‹œì§€ ì „ì†¡
                if (window.flutter_inappwebview && window.flutter_inappwebview.postMessage) {
                    window.flutter_inappwebview.postMessage(JSON.stringify(message));
                }

                // ì¼ë°˜ postMessage (ë¶€ëª¨ í”„ë ˆì„ìœ¼ë¡œ)
                if (window.parent !== window) {
                    window.parent.postMessage(message, '*');
                }

                console.log(`ğŸ“¤ To Flutter: ${action}`, data);
            }

            async startAR() {
                try {
                    this.showStatus('AR ì„¸ì…˜ ì‹œì‘ ì¤‘...');
                    this.sendToFlutter('ar_starting');

                    await this.modelViewer.activateAR();
                    this.startArBtn.classList.add('hidden');

                } catch (error) {
                    console.error('AR ì‹œì‘ ì‹¤íŒ¨:', error);
                    this.showStatus('AR ì‹œì‘ ì‹¤íŒ¨');
                    this.sendToFlutter('ar_failed', { error: error.message });
                }
            }

            handleARStatus(status) {
                console.log('ğŸ“± AR Status:', status);
                this.sendToFlutter('ar_status_changed', { status: status });

                switch (status) {
                    case 'session-started':
                        this.onARSessionStart();
                        break;
                    case 'object-placed':
                        this.onObjectPlaced();
                        break;
                    case 'failed':
                        this.onARFailed();
                        break;
                    case 'not-presenting':
                        this.onAREnd();
                        break;
                }
            }

            onARSessionStart() {
                console.log('âœ… AR Session Started');
                this.isARActive = true;
                this.showStatus('AR ëª¨ë“œ í™œì„±í™”ë¨');
                this.sendToFlutter('ar_session_started');

                // Flutterì—ì„œ ì œì–´í•˜ì§€ ì•ŠëŠ” ê²½ìš° ìë™ìœ¼ë¡œ ë°°ì¹˜ ëª¨ë“œ í™œì„±í™”
                if (!this.isFlutterConnected) {
                    setTimeout(() => {
                        this.enablePlacementMode();
                    }, 2000);
                }
            }

            onObjectPlaced() {
                console.log('âœ… Object Placed');
                this.isPlacementMode = false;
                this.showStatus('êµíšŒ ëª¨ë¸ì´ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤');
                this.sendToFlutter('object_placed');
                this.clearHitIndicators();
            }

            onARFailed() {
                console.error('âŒ AR Failed');
                this.showStatus('AR ì‹¤í–‰ ì‹¤íŒ¨');
                this.sendToFlutter('ar_failed');
                this.resetUI();
            }

            onAREnd() {
                console.log('ğŸ“± AR Session Ended');
                this.isARActive = false;
                this.showStatus('AR ì„¸ì…˜ ì¢…ë£Œë¨');
                this.sendToFlutter('ar_session_ended');
                this.resetUI();
            }

            enablePlacementMode() {
                this.isPlacementMode = true;
                this.showStatus('ë°°ì¹˜ ëª¨ë“œ í™œì„±í™” - í™”ë©´ì„ í„°ì¹˜í•˜ì„¸ìš”');
                this.sendToFlutter('placement_mode_enabled');

                // ê°€ìƒ hit test points ì‹œë®¬ë ˆì´ì…˜
                this.simulateHitTesting();
            }

            disablePlacementMode() {
                this.isPlacementMode = false;
                this.clearHitIndicators();
                this.sendToFlutter('placement_mode_disabled');
            }

            simulateHitTesting() {
                if (!this.isPlacementMode || !this.isARActive) return;

                // í™”ë©´ì— ê°€ìƒ hit test points í‘œì‹œ
                this.clearHitIndicators();

                const points = [
                    { x: this.modelViewer.clientWidth * 0.3, y: this.modelViewer.clientHeight * 0.6 },
                    { x: this.modelViewer.clientWidth * 0.5, y: this.modelViewer.clientHeight * 0.7 },
                    { x: this.modelViewer.clientWidth * 0.7, y: this.modelViewer.clientHeight * 0.6 }
                ];

                points.forEach((point, index) => {
                    setTimeout(() => {
                        this.addHitIndicator(point.x, point.y);
                    }, index * 500);
                });

                // ì§€ì†ì ì¸ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    if (this.isPlacementMode) {
                        this.simulateHitTesting();
                    }
                }, 3000);
            }

            addHitIndicator(x, y) {
                const indicator = document.createElement('div');
                indicator.className = 'hit-indicator';
                indicator.style.left = `${x}px`;
                indicator.style.top = `${y}px`;
                this.placementOverlay.appendChild(indicator);

                // 5ì´ˆ í›„ ì œê±°
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                }, 5000);
            }

            clearHitIndicators() {
                this.placementOverlay.innerHTML = '';
            }

            handlePlacementTouch(event) {
                if (!this.isPlacementMode || !this.isARActive) return;

                const rect = this.modelViewer.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;

                console.log(`ğŸ“ Placement touch at: ${x}, ${y}`);

                // Flutterì— í„°ì¹˜ ì •ë³´ ì „ì†¡
                this.sendToFlutter('placement_touch', { x: x, y: y });

                // ë°°ì¹˜ ì‹œë„
                this.attemptPlacement(x, y);
            }

            attemptPlacement(x, y) {
                // ë°°ì¹˜ ì„±ê³µ ì‹œë®¬ë ˆì´ì…˜
                const success = Math.random() > 0.3; // 70% ì„±ê³µë¥ 

                if (success) {
                    this.showStatus('ë°°ì¹˜ ì„±ê³µ!');
                    setTimeout(() => {
                        this.onObjectPlaced();
                    }, 1000);
                } else {
                    this.showStatus('í‰ë©´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”');
                }
            }

            simulatePlacement(x, y) {
                // Flutterì—ì„œ í˜¸ì¶œí•˜ëŠ” ë°°ì¹˜ ì‹œë®¬ë ˆì´ì…˜
                this.attemptPlacement(x, y);
            }

            updateModel(modelUrl) {
                this.modelViewer.src = modelUrl;
                this.sendToFlutter('model_updated', { url: modelUrl });
            }

            hideControls() {
                document.getElementById('ar-controls').style.display = 'none';
            }

            showControls() {
                document.getElementById('ar-controls').style.display = 'flex';
            }

            resetAR() {
                this.disablePlacementMode();
                this.resetUI();
                this.sendToFlutter('ar_reset');
            }

            showStatus(message) {
                this.statusMessage.textContent = message;
                this.statusMessage.classList.add('show');

                setTimeout(() => {
                    this.statusMessage.classList.remove('show');
                }, 3000);
            }

            resetUI() {
                this.startArBtn.classList.remove('hidden');
                this.isARActive = false;
                this.isPlacementMode = false;
                this.clearHitIndicators();
            }
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const flutterBridge = new FlutterARBridge();

            // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•œ ì„¤ì •
            window.flutterARBridge = flutterBridge;

            // Flutterì—ì„œ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì „ì—­ í•¨ìˆ˜ë“¤
            window.startAR = () => flutterBridge.startAR();
            window.enablePlacement = () => flutterBridge.enablePlacementMode();
            window.disablePlacement = () => flutterBridge.disablePlacementMode();
            window.resetAR = () => flutterBridge.resetAR();

            console.log('ğŸš€ Flutter AR Bridge Ready');
        });

        // Flutter í†µì‹  í…ŒìŠ¤íŠ¸ìš© í•¨ìˆ˜ë“¤
        window.testFlutterBridge = {
            simulateFlutterMessage: (action, data) => {
                if (window.flutterARBridge) {
                    window.flutterARBridge.handleFlutterAction(action, data);
                }
            },
            sendTestMessage: () => {
                if (window.flutterARBridge) {
                    window.flutterARBridge.sendToFlutter('test_message', { test: 'success' });
                }
            },
            startARTest: () => {
                window.startAR();
            }
        };
    </script>
</body>
</html>